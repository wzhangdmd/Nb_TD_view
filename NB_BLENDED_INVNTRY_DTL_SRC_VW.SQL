REPLACE VIEW PROD_NBR_VW.NB_BLENDED_INVNTRY_DTL_SRC_VW
AS LOCKING ROW FOR ACCESS
(
SELECT 
  SMBD.COMP_MRG_AGY_SRC_SYS_PRTY_ID AS MRG_AGENCY_SRC_SYS_PRTY_ID
, BLENDED_INVENTORY.LOB
, BLENDED_INVENTORY.HLDG_KEY
, BLENDED_INVENTORY.INS_LAST_NAME||','|| BLENDED_INVENTORY.INS_FIRST_NAME INS_FULL_NM
, SMBD.SOLICITING_AGT_SRC_SYS_PRTY_ID
, COALESCE(SMBD.SOLICITING_AGT_FULL_NM, 'Unkown')  AS SOLICITING_AGT_FULL_NM
, SMBD.SOLICITING_AGT_TYP_CD
, SMBD.COMP_SOL_AGT_SRC_SYS_PRTY_ID
, COALESCE(SMBD.COMP_SOL_AGT_FULL_NM, 'Unkown') AS COMP_SOL_AGT_FULL_NM
, SMBD.COMP_SOL_AGT_TYP_CD
, SMBD.COMP_PCT
, SMBD.UNIT_STRT_DT
, SMBD.UNIT_END_DT
, SMBD.COMP_SM_BKD_SRC_SYS_PRTY_ID  AS SM_BKD_SRC_SYS_PRTY_ID
, SMBD.COMP_SM_BKD_NM  AS SM_BKD_NM
, SMBD.SPLIT_STRT_DT
, SMBD.SPLIT_END_DT
, SMBD.SM_SPLIT_PCT
, BLENDED_INVENTORY.SUBMISSION_DATE
, BLENDED_INVENTORY.FACE_AMOUNT
, CAST( BLENDED_INVENTORY.WEIGHTED_ANNUAL_PREM_AMT *  ( COALESCE( SMBD.COMP_PCT , 100 ) / 100 ) * ( COALESCE( SM_SPLIT_PCT , 100 ) / 100 ) AS DEC(18,2) ) AS WEIGHTED_ANNUAL_PREM_AMT
, CAST( BLENDED_INVENTORY.ESTIMATED_FYC *  ( COALESCE( SMBD.COMP_PCT , 100 ) / 100 ) * ( COALESCE( SM_SPLIT_PCT , 100 ) / 100 ) AS DEC(18,2) ) AS ESTIMATED_FYC
, CAST( BLENDED_INVENTORY.ANNUAL_PREMIUM *  ( COALESCE( SMBD.COMP_PCT , 100 ) / 100 ) * ( COALESCE( SM_SPLIT_PCT , 100 ) / 100 ) AS DEC(18,2) ) AS ANNUAL_PREMIUM
, BLENDED_INVENTORY.INVENTORY_STATUS
, BLENDED_INVENTORY.INVENTORY_REASON
, BLENDED_INVENTORY.UW_FULL_NM
, BLENDED_INVENTORY.ORGANIZATION_BUSINESS_TYPE_CD
, BLENDED_INVENTORY.REQUIREMENTS
,BLENDED_INVENTORY.PREPAID_PREMIUM_IND
,BLENDED_INVENTORY.CAL_DAYS_SINCE_APRV
,BLENDED_INVENTORY.SPECIALIST_FULL_NM
,BLENDED_INVENTORY.PROD_ID
, BLENDED_INVENTORY.APPLICATION_ISSUE_DATE
 ,LST_MRG.MRG_AGY_LST
FROM

(
/*		LIFE & DI - Pending Policies	*/


SELECT	 DISTINCT 
 LOB
, A.HLDG_KEY
, UPPER(A.INS_LAST_NAME) AS INS_LAST_NAME
, UPPER(A.INS_FIRST_NAME) AS INS_FIRST_NAME
, A.SUBMISSION_DATE
, A.FACE_AMOUNT
, A.WEIGHTED_ANNUAL_PREM_AMT
, A.ESTIMATED_FYC
, A.ANNUAL_PREMIUM
, A.INVENTORY_STATUS
, A.INVENTORY_REASON
, A.UW_FULL_NM
, A.ORGANIZATION_BUSINESS_TYPE_CD
, A.REQUIREMENTS
,A.PREPAID_PREMIUM_IND
,A.CAL_DAYS_SINCE_APRV
,CASE
	WHEN CHAR_LENGTH(TRIM(BOTH ' ' FROM A.CM_FIRST_NAME))>1  THEN A.CM_FIRST_NAME|| ' ' || A.CM_LAST_NAME
	ELSE A.CM_LAST_NAME
END AS SPECIALIST_FULL_NM
,A.PROD_ID
,A.APPLICATION_ISSUE_DATE

FROM	PROD_NBR_VW.NB_PENDING_INVENTORY_DTL_VW A


) BLENDED_INVENTORY

LEFT OUTER JOIN  PROD_NBR_VW.NB_SOL_COMP_SMBD_VW SMBD
ON SMBD.HLDG_KEY = BLENDED_INVENTORY.HLDG_KEY
AND SMBD.SRC_SYS IN ('TPP' , 'WINRISK','DIPMS' ) 

LEFT OUTER JOIN 
 (SELECT SRC_SYS, HLDG_KEY
                 ,TRIM(MAX( CASE WHEN RN= 1 THEN COMP_MRG_AGY_SRC_SYS_PRTY_ID ELSE ' ' END )
                 || MAX( CASE WHEN RN= 2 THEN  ',' || COMP_MRG_AGY_SRC_SYS_PRTY_ID ELSE ' ' END  )
                 || MAX( CASE WHEN RN= 3 THEN  ',' || COMP_MRG_AGY_SRC_SYS_PRTY_ID ELSE ' ' END  )
                 || MAX( CASE WHEN RN= 4 THEN  ',' || COMP_MRG_AGY_SRC_SYS_PRTY_ID ELSE ' ' END  )
                 || MAX( CASE WHEN RN= 5 THEN  ',' || COMP_MRG_AGY_SRC_SYS_PRTY_ID ELSE ' ' END  )
                 || MAX( CASE WHEN RN= 6 THEN  ',' || COMP_MRG_AGY_SRC_SYS_PRTY_ID ELSE ' ' END  ) ) AS MRG_AGY_LST
 FROM 
 (SELECT SRC_SYS, HLDG_KEY, COMP_MRG_AGY_SRC_SYS_PRTY_ID, ROW_NUMBER() OVER(PARTITION BY SRC_SYS, HLDG_KEY ORDER BY HLDG_KEY) RN
FROM 
(SELECT SRC_SYS, HLDG_KEY, COMP_MRG_AGY_SRC_SYS_PRTY_ID
   FROM PROD_NBR_VW.NB_SOL_COMP_SMBD_VW
   WHERE  SRC_SYS IN ('TPP' , 'WINRISK','DIPMS' ) GROUP BY 1,2,3
  ) SRC   
   ) src2 GROUP BY 1,2
   )  LST_MRG 
  ON SMBD.HLDG_KEY = LST_MRG.HLDG_KEY
   AND SMBD.SRC_SYS = LST_MRG.SRC_SYS
   ) ;
