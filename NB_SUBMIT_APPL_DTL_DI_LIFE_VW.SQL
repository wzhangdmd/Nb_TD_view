REPLACE VIEW PROD_NBR_VW.NB_SUBMIT_APPL_DTL_DI_LIFE_VW
AS LOCKING ROW FOR ACCESS 
(
SELECT 
 					  SMBD.COMP_MRG_AGY_SRC_SYS_PRTY_ID AS MRG_AGENCY_SRC_SYS_PRTY_ID
					, SMBD.COMP_MRG_ENT_NM    AS MRG_ENT_NM
					, SUB.ORGANIZATION_BUSINESS_TYPE_CD
					, SUB.HLDG_KEY
					, SMBD.SOLICITING_AGT_FULL_NM
					, SMBD.SOLICITING_AGT_SRC_SYS_PRTY_ID
					, SMBD.SOLICITING_AGT_TYP_CD 
					, CASE WHEN  SMBD.SOLICITING_AGT_TYP_CD = 'CAS' THEN 'CAREER'  WHEN  SMBD.SOLICITING_AGT_TYP_CD = 'CAB' THEN 'BROKER' ELSE 'Unknown' END   AS SOLICITING_AGT_TYP_DESC 
					, SUB.SUBMISSION_DATE
					, SUB.CURR_STATUS_EVENT_DT
					, SUB.CURR_STATUS_EVENT_DETAIL
					, SUB.PREPAID_PREMIUM_IND
					, SUB.WEIGHTED_ANNUAL_PREM_AMT
					, SUB.ESTIMATED_FYC
					, SUB.ANNL_PREM
					, SUB.COV_ADL_PREM
					, SUB.APPL_1035_AS_PREM
					, SUB.INS_LAST_NAME
					, SUB.INS_FIRST_NAME
					, SUB.INS_FULL_NAME
					, SUB.PRODUCT_TYPE
					, SUB.PROD_ID
					, SMBD.SOL_SM_BKD_NM  AS SALES_UNIT_MANAGER 
					, SMBD.SOL_SM_BKD_SRC_SYS_PRTY_ID  AS SALES_MANAGER_UID
					, SUB.REPL_TYP_DESC
					, SUB.REPLACEMENT_INSURANCE_IND
					, SUB.REPLACEMENT_CNT
					, SUB.SIGN_METH
					, SUB.ESIGN_CNT
					, SUB.EZAPP_CNT
					, SUB.GRADED_PREMIUM
					, SUB.GROUP_SRC_SYS_PRTY_ID
					, SUB.GROUP_FULL_NM
					, SUB.SRC_SYS
					, COALESCE(EXP_L.EXP_LVL,'') EXP_LVL
					, SMBD.COMP_SOL_AGT_SRC_SYS_PRTY_ID
					, SMBD.COMP_SOL_AGT_FULL_NM
					, SMBD.COMP_SOL_AGT_TYP_CD
					, SMBD.COMP_PCT
					, SMBD.UNIT_STRT_DT
					, SMBD.UNIT_END_DT
					, SMBD.COMP_SM_BKD_SRC_SYS_PRTY_ID AS SM_BKD_SRC_SYS_PRTY_ID
					, SMBD.COMP_SM_BKD_NM  AS SM_BKD_NM
					, SMBD.SPLIT_STRT_DT
					, SMBD.SPLIT_END_DT
					, SMBD.SM_SPLIT_PCT
					, CAST( SUB.WEIGHTED_ANNUAL_PREM_AMT *  ( COALESCE( SMBD.COMP_PCT , 100 ) / 100 ) * ( COALESCE( SM_SPLIT_PCT , 100 ) / 100 ) AS DEC(18,2) ) AS COMP_WEIGHTED_ANNUAL_PREM_AMT
					, CAST( SUB.ESTIMATED_FYC *  ( COALESCE( SMBD.COMP_PCT , 100 ) / 100 ) * ( COALESCE( SM_SPLIT_PCT , 100 ) / 100 ) AS DEC(18,2) ) AS COMP_ESTIMATED_FYC
					, CAST( SUB.ANNL_PREM *  ( COALESCE( SMBD.COMP_PCT , 100 ) / 100 ) * ( COALESCE( SM_SPLIT_PCT , 100 ) / 100 ) AS DEC(18,2) ) AS COMP_ANNUAL_PREMIUM

                                        , APPLICATION_TYPE
FROM
(
SELECT	 
					 a.ORGANIZATION_BUSINESS_TYPE_CD
					, a.HLDG_KEY
					, a.SOLICITING_AGT_FULL_NM
					, a.SOLICITING_AGT_SRC_SYS_PRTY_ID
					, a.SOLICITING_AGT_TYP_CD 
					, a.SOLICITING_AGT_TYP_DESC 
					, a.SUBMISSION_DATE
					, a.CURR_STATUS_EVENT_DT
					, a.CURR_STATUS_EVENT_DETAIL
					, a.PREPAID_PREMIUM_IND
					, a.WEIGHTED_ANNUAL_PREM_AMT
					, a.ESTIMATED_FYC
					, a.ANNL_PREM
					, a.COV_ADL_PREM
					, a.APPL_1035_AS_PREM
					, a.INS_LAST_NAME
					, a.INS_FIRST_NAME
					, a.INS_FULL_NAME
					, a.PRODUCT_TYPE
					, a.PROD_ID
					, a.SALES_UNIT_MANAGER 
					, a.SALES_MANAGER_UID
					, a.REPL_TYP_DESC
					, a.REPLACEMENT_INSURANCE_IND
					, a.REPLACEMENT_CNT
					, a.SIGN_METH
					, a.ESIGN_CNT
					, a.EZAPP_CNT
					, a.GRADED_PREMIUM
					, a.GROUP_SRC_SYS_PRTY_ID
					, a.GROUP_FULL_NM
					, a.SRC_SYS
                                        , a.APPLICATION_TYPE
				
FROM	PROD_NBR_VW.NB_SUBMIT_APPL_DTL_VW a

) SUB

LEFT OUTER JOIN PROD_NBR_VW.NB_SOL_COMP_SMBD_VW SMBD
ON SUB.HLDG_KEY = SMBD.HLDG_KEY
AND SMBD.SRC_SYS IN ('DIPMS' , 'TPP', 'WINRISK' )


LEFT OUTER JOIN 
(
select 
'AA' || TRIM ( SUBSTR(BUSINESS_PARTNER_ID , 5 , 6 ) ) BUSINESS_PARTNER_ID,
case 
when CMN.PRD_BPID is not null then 'Contract B'
when CAS_IND='N' then ''
when PRTY_STUS='TMP' then 'Termed' 
when (CURRENT_DATE-FT_ST_DT)<=1460 then '1-4'
when (CURRENT_DATE-FT_ST_DT)>=1461 then '5+'
end EXP_LVL
from PROD_USIG_STND_VW.PDCR_DEMOGRAPHICS_VW LEFT OUTER JOIN 
(
select DISTINCT PRD_BPID
from PROD_USIG_STND_VW.SALES_HIERARCHY_VW
where 
PRD_STD_CONTR_TYP='Z210'
and PRD_STUS='ACTIVE'
) CMN
on BUSINESS_PARTNER_ID=CMN.PRD_BPID
where 
FT_ST_DT<>'0001-01-01'
) EXP_L
 ON SMBD.COMP_SOL_AGT_SRC_SYS_PRTY_ID=EXP_L.BUSINESS_PARTNER_ID

          
WHERE EXTRACT(YEAR FROM SUBMISSION_DATE )  >= EXTRACT(YEAR FROM CURRENT_DATE)-2

--	Remove duplicate relationships - choose the latest rNB_SOL_COMP_SMBD_VWelationship when Producer has more than one to a Unit

QUALIFY ( ROW_NUMBER() OVER ( PARTITION BY  SUB.HLDG_KEY
                                                                                            , SMBD.SOL_MRG_AGY_SRC_SYS_PRTY_ID
																							, SMBD.COMP_SOL_AGT_SRC_SYS_PRTY_ID
																							, SMBD.COMP_MRG_AGY_SRC_SYS_PRTY_ID
																							, SMBD.COMP_SM_BKD_SRC_SYS_PRTY_ID																					
																							
																							ORDER BY CASE WHEN  SMBD.COMP_SOL_AGT_TYP_CD='CAS' THEN 1 ELSE 2 END  ) = 1 )   
	);
