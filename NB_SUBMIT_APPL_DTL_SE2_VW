REPLACE VIEW PROD_NBR_VW.NB_SUBMIT_APPL_DTL_SE2_VW
AS LOCKING ROW FOR ACCESS 
(
SELECT 
cast(SMBD.COMP_MRG_AGY_SRC_SYS_PRTY_ID as char(3)) as MRG_AGENCY_SRC_SYS_PRTY_ID
,SMBD.COMP_MRG_ENT_NM  AS MRG_ENT_NM
,ORGANIZATION_BUSINESS_TYPE_CD
,SUB.HLDG_KEY
,SMBD.SOLICITING_AGT_FULL_NM
,SMBD.SOLICITING_AGT_SRC_SYS_PRTY_ID
,SMBD.SOLICITING_AGT_TYP_CD
,CASE WHEN SMBD.SOLICITING_AGT_TYP_CD = 'CAS' THEN 'CAREER'  WHEN SMBD.SOLICITING_AGT_TYP_CD = 'CAB' THEN 'BROKER' ELSE 'Unknown' END AS SOLICITING_AGT_TYP_DESC 
,SUBMISSION_DATE
,CURR_STATUS_EVENT_DT
, CASE WHEN STUS.TRNSLT_FLD_VAL = 'NB'   THEN 'Pending'
              WHEN STUS.TRNSLT_FLD_VAL = 'NR'  THEN 'Incomplete/Withdrawn'
              WHEN STUS.TRNSLT_FLD_VAL = 'TM'  THEN 'Not Taken'
              WHEN STUS.TRNSLT_FLD_VAL = 'IF'     THEN 'Reported'
  END  AS CURR_STATUS_EVENT_DETAIL
,'' PREPAID_PREMIUM_IND
,AGMT_TOT_ANNUAL_PREM_AMT WEIGHTED_ANNUAL_PREM_AMT
,(AGMT_TOT_ANNUAL_PREM_AMT*0.03) ESTIMATED_FYC 
,AGMT_TOT_ANNUAL_PREM_AMT  ANNL_PREM
,0 COV_ADL_PREM
,0 APPL_1035_AS_PREM
,UPPER(INS_LAST_NAME) INS_LAST_NAME
,UPPER(INS_FIRST_NAME) INS_FIRST_NAME
,case when CHAR_LENGTH(TRIM(BOTH ' ' FROM INS_FIRST_NAME))>1  THEN UPPER(INS_LAST_NAME)|| ', ' ||UPPER(INS_FIRST_NAME) ELSE  UPPER(INS_LAST_NAME) end as INS_FULL_NAME
,ORGANIZATION_BUSINESS_TYPE_CD PRODUCT_TYPE
,'' PROD_ID
, SMBD.SOL_SM_BKD_NM AS SALES_UNIT_MANAGER
, SMBD.SOL_SM_BKD_SRC_SYS_PRTY_ID  AS SALES_MANAGER_UID
 ,(case 
		when REPL_TYP_CDE='I' then 'Internal' 
		when REPL_TYP_CDE='E' then 'External' 
		else 'Not a Replacement'
		End) 	REPL_TYP_DESC
,'' REPLACEMENT_INSURANCE_IND
,0 REPLACEMENT_CNT
,cast(null as varchar(20)) as SIGN_METH
,0 ESIGN_CNT
,0 EZAPP_CNT
,cast(null as char(1)) GRADED_PREMIUM
,''GROUP_SRC_SYS_PRTY_ID
,''GROUP_FULL_NM
,'ANN' SRC_SYS
,COALESCE(EXP_L.EXP_LVL,'') as EXP_LVL
,  SMBD.COMP_SOL_AGT_SRC_SYS_PRTY_ID AS COMP_SOL_AGT_SRC_SYS_PRTY_ID
,  SMBD.COMP_SOL_AGT_FULL_NM AS COMP_SOL_AGT_FULL_NM
,  SMBD.COMP_SOL_AGT_TYP_CD AS COMP_SOL_AGT_TYP_CD
, SMBD.UNIT_STRT_DT AS UNIT_STRT_DT
, SMBD.UNIT_END_DT AS UNIT_END_DT
, SMBD.COMP_SM_BKD_SRC_SYS_PRTY_ID AS SM_BKD_SRC_SYS_PRTY_ID
, SMBD.COMP_SM_BKD_NM AS SM_BKD_NM
, SMBD.SPLIT_STRT_DT AS SPLIT_STRT_DT
, SMBD.SPLIT_END_DT AS SPLIT_END_DT
, SMBD.SM_SPLIT_PCT AS SM_SPLIT_PCT

, SMBD.COMP_PCT

, CAST( WEIGHTED_ANNUAL_PREM_AMT *  ( COALESCE( SMBD.COMP_PCT , 100 ) / 100 ) * ( COALESCE( SM_SPLIT_PCT , 100 ) / 100 ) AS DEC(18,2) ) AS COMP_WEIGHTED_ANNUAL_PREM_AMT
, CAST( ESTIMATED_FYC *  ( COALESCE( SMBD.COMP_PCT , 100 ) / 100 ) * ( COALESCE( SM_SPLIT_PCT , 100 ) / 100 ) AS DEC(18,2) ) AS COMP_ESTIMATED_FYC
, CAST( ANNL_PREM *  ( COALESCE( SMBD.COMP_PCT , 100 ) / 100 ) * ( COALESCE( SM_SPLIT_PCT , 100 ) / 100 ) AS DEC(18,2) ) AS COMP_ANNUAL_PREMIUM
, CAST(' ' AS CHAR(8) ) AS APPLICATION_TYPE

FROM 
(
SELECT
DISTINCT 
AGMT.LOB_CDE,
TRIM(LEADING '0' FROM AGMT.HLDG_KEY) HLDG_KEY,
CUST.LST_NM INS_LAST_NAME,
CUST.FIRST_NM INS_FIRST_NAME,
CUST.FULL_NM INS_FULL_NM,
(case when AGMT.HO_RECEIPT_DATE='0001-01-01' then AGMT.SIGNED_DATE else AGMT.HO_RECEIPT_DATE end) SUBMISSION_DATE,
AGMT.BEN_AMT FACE_AMOUNT,
REPL.AGMT_TOT_ANNUAL_PREM_AMT AGMT_TOT_ANNUAL_PREM_AMT,
AGMT.HLDG_STUS AGMT_STUS_CD,
AGMT.PROD_TYP_NME ORGANIZATION_BUSINESS_TYPE_CD,
AGMT.CTRT_JURISDICTION,
AGMT.REPLACEMENT_INDICATOR,
REPL.REPL_TYP_CDE,
AGMT.AGREEMENT_STATUS_START_DTTM CURR_STATUS_EVENT_DT
FROM
PROD_USIG_STND_VW.AGMT_CMN_VW AGMT  
LEFT OUTER JOIN 
(
select AGREEMENT_ID,MIN(REPL_TYP_CDE) REPL_TYP_CDE
     ,SUM(TRANSFER_AMOUNT) AGMT_TOT_ANNUAL_PREM_AMT
    from PROD_USIG_STND_VW.AGMT_REPLACEMENTS_CMN_VW 
where AGREEMENT_SOURCE_CD='SE2' 
and CURR_IND='Y'
group by AGREEMENT_ID
) REPL on AGMT.AGREEMENT_ID=REPL.AGREEMENT_ID


LEFT OUTER JOIN 
( 
SELECT A.AGREEMENT_ID, B.FIRST_NM, B.LST_NM,B.LST_NM||', '||B.FIRST_NM FULL_NM FROM PROD_USIG_STND_VW.CUST_AGMT_CMN_VW A 
LEFT OUTER JOIN PROD_USIG_STND_VW.CUST_DEMOGRAPHICS_VW B on A.PRTY_ID=B.PRTY_ID
WHERE A.AGREEMENT_SOURCE_CD='SE2' AND A.PRTY_AGMT_RLE_CD = 'INSD' AND A.PRTY_AGMT_RLE_STYP_CD = 'PRMR'
QUALIFY(row_number() over (partition by AGREEMENT_ID,B.GOVT_ID_NR order by B.PRTY_DATA_FR_DT DESC))=1
) CUST on AGMT.AGREEMENT_ID=CUST.AGREEMENT_ID

WHERE 
AGMT.AGREEMENT_SOURCE_CD='SE2' AND 
EXTRACT(YEAR FROM SUBMISSION_DATE )  >= (EXTRACT(YEAR FROM CURRENT_DATE)-2) AND
AGMT.DISTRIBUTION_CHANNEL='CAS' /* Added to fllter to get only CAS Agreements */
) SUB


LEFT OUTER JOIN 
(
select 
distinct 
TRNSLT_FLD_VAL,
VA_SHT_DESC
from 
PROD_USIG_CMN_VW.SRC_DATA_TRNSLT_VW where SRC_CDE='SE2' and TRNSLT_FLD_NM='STATUS CODE'
) STUS
on SUB.AGMT_STUS_CD=STUS.TRNSLT_FLD_VAL


LEFT OUTER JOIN PROD_NBR_VW.NB_SOL_COMP_SMBD_VW SMBD
ON SUB.HLDG_KEY=SMBD.HLDG_KEY
AND SMBD.SRC_SYS='SE2'


LEFT OUTER JOIN 
(
select 
'AA' || TRIM ( SUBSTR(BUSINESS_PARTNER_ID , 5 , 6 ) ) BUSINESS_PARTNER_ID,
case 
when CMN.PRD_BPID is not null then 'Contract B'
when CAS_IND='N' then ''
when PRTY_STUS='TMP' then 'Termed' 
when (CURRENT_DATE-FT_ST_DT)<=1460 then '1-4'
when (CURRENT_DATE-FT_ST_DT)>=1461 then '5+'
end EXP_LVL
from PROD_USIG_STND_VW.PDCR_DEMOGRAPHICS_VW LEFT OUTER JOIN 
(
select DISTINCT PRD_BPID
from PROD_USIG_ACCESS_VW.SALES_HIERARCHY_VW
where 

PRD_STD_CONTR_TYP='Z210'
and PRD_STUS='ACTIVE'
) CMN
on BUSINESS_PARTNER_ID=CMN.PRD_BPID
where 
FT_ST_DT<>'0001-01-01'
) EXP_L 
ON SMBD.COMP_SOL_AGT_SRC_SYS_PRTY_ID=EXP_L.BUSINESS_PARTNER_ID


--	Remove duplicate relationships - choose the latest relationship when Producer has more than one to a Unit

QUALIFY ( ROW_NUMBER() OVER ( PARTITION BY SUB.HLDG_KEY
                                                                                            , SMBD.SOL_MRG_AGY_SRC_SYS_PRTY_ID
																							, SMBD.COMP_SOL_AGT_SRC_SYS_PRTY_ID
																							, SMBD.COMP_MRG_AGY_SRC_SYS_PRTY_ID
																							, SMBD.SOLICITING_AGT_TYP_CD  
																							, SMBD.COMP_SOL_AGT_TYP_CD  
																							, SMBD.COMP_SM_BKD_SRC_SYS_PRTY_ID
																							ORDER BY  SUB.HLDG_KEY,SMBD.SOL_MRG_AGY_SRC_SYS_PRTY_ID, SMBD.COMP_SOL_AGT_SRC_SYS_PRTY_ID ,  CASE WHEN SMBD.COMP_SOL_AGT_TYP_CD='CAS' THEN 1 ELSE 2 END   ) = 1 )
);
